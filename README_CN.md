# ComfyUI Matrix Nodes

**[🇺🇸 English](README.md)**

一套专为 **提示词驱动 (Prompt-Driven)** 工作流设计的强大节点。支持 10 通道动态加载、智能 ID 解析、精准文本切割、本地化 Qwen-VL 编码以及高效视频合成。

---

## ✨ 核心功能

- **十通道全开**: 矩阵类节点支持 1-10 路输入输出。**未连接的插槽会自动忽略**。
- **智能 ID 解析**: 输入 `"X1"` 自动匹配 `X1.jpg`、`X01.png` 或 `X1-描述.webp`。
- **高效视频合成**: 采用 FFmpeg 管道流技术，不产生中间垃圾文件，支持音频自动混流。
- **Qwen-VL 集成**: 内置魔改版 Qwen 编码节点，支持智能空图过滤和 Latent 自动对齐。
- **精准切割**: 新增 **字符切割刀** 节点，支持自定义左右符号截取文本。
- **可视化报错**: 找不到图片时生成灰色警告图，不卡死工作流。

---

## 📦 包含节点

### 1. Matrix Image Loader (String 5 / 10) | 矩阵-字符加载器
**终极加载器**。直接接受字符串输入。
- **输入**: 字符串（文件名、ID 如 "X1"、或关键词）。
- **智能逻辑**: 自动归一化 ID，智能排序匹配。

### 2. Matrix Prompt Splitter (5 / 10) | 矩阵-文本拆分器
**文本拆分器**。将长文本拆分为 5 或 10 个独立的输出字符串。
- **配置**: 支持自定义中英文括号（`[]`, `【】`）和各种分隔符。

### 3. Matrix ID Extractor | 矩阵-ID智能提取
**文本提取器**。从叙述性文本中“嗅探”出 ID。
- **功能**: 支持 Auto 智能模式和 Custom 自定义位模式。可分离 ID 与后续描述文本。

### 4. Matrix String Slicer | 矩阵-字符切割刀
**文本手术刀**。截取两个自定义符号之间的文本。
- **场景**: 处理复杂格式字符串，如 `004-[X1|Y2]-远景`。
- **功能**: 自定义左右符号（支持汉字）、选择第 N 个匹配项、是否保留符号本身。

### 5. Matrix Loader (Index 5 / 10) | 矩阵-滑块加载器
**经典版**。通过“前缀+数字滑块”的方式控制。

### 6. Matrix Qwen Encode (5 / 10) | Qwen-VL编码器
**魔改版 Qwen-VL 编码器**。
- **纯净版**: 移除 API 依赖，纯本地运行。
- **智能过滤**: 自动忽略输入的纯黑/纯白占位图。
- **绝对对齐**: 无论场景图连在哪个插槽，选中后自动重排至首位，确保模型正确识别背景。

### 7. Matrix Video Combine | 矩阵-视频合成
**高效编码器**。通过 FFmpeg 管道直接将图片流编码为视频。
- **纯净**: 内存直通 FFmpeg，硬盘里不留任何中间图片。
- **功能**: 支持音频输入（自动裁剪/混流），支持 MP4/WebP/GIF。
- **预览**: 可生成临时的低分辨率 WebP 动图，方便在节点上快速预览结果。

---

## 🛠 安装方法

1. 进入 ComfyUI 的 custom_nodes 文件夹。

2. 运行 git 命令克隆本仓库：

    git clone https://github.com/gnrsbassoutlook/ComfyUI-Matrix-Nodes.git

3. 重启 ComfyUI。

---

## 🚀 使用示例 (视频合成)

**场景**: 你生成了一组序列帧，并且有一段音频。

1. **Matrix Video Combine**:
   - **Images**: 连接图片序列。
   - **Audio**: (可选) 连接音频输出。
   - **Format**: `video/h264-mp4`。
   - **Preview GIF**: `True` (生成预览动图)。

2. **结果**:
   - Output 文件夹中生成高清有声 MP4。
   - 节点界面显示缩略动图以确认内容。
   - Temp 文件夹中的临时预览图重启即删。

---

## 📄 License

MIT License